{% extends 'base_admin.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="container my-5 d-flex justify-content-center">
  <div class="card shadow-sm" style="max-width: 480px; width: 100%; 
      border-radius: 15px; 
      background: #f8f9fa; /* gris muy suave */
      border: 1px solid #ddd;">
    <div class="card-header text-center p-4" 
         style="background: #e2e6ea; /* gris claro */
                border-top-left-radius: 15px; 
                border-top-right-radius: 15px;">
      <h3 class="fw-bold mb-1" style="color: #2c3e50;">Gestionar Devolución</h3>
      <small class="opacity-75" style="color: #6c757d;">
        Material: <span class="fst-italic">{{ item.material.nom_material }}</span>
      </small>
    </div>
    <div class="card-body p-4">
      <form method="post" novalidate id="devolucionForm">
        {% csrf_token %}
        
        {% for field in form %}
          <div class="mb-4">
            <label for="{{ field.id_for_label }}" 
                   class="form-label fw-semibold text-secondary" 
                   style="color: #495057;">{{ field.label }}</label>
            {{ field|add_class:"form-control form-control-lg rounded-3 shadow-sm" }}
            {% if field.help_text %}
              <div class="form-text" style="color: #6c757d;">{{ field.help_text }}</div>
            {% endif %}
            {% for error in field.errors %}
              <div class="text-danger small mt-1">{{ error }}</div>
            {% endfor %}
          </div>
        {% endfor %}
        
        <button type="submit" 
                class="btn btn-primary w-100 fw-bold py-2 rounded-3 shadow"
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                       border: none; 
                       box-shadow: 0 4px 12px rgb(118 75 162 / 0.4);">
          <i class="bi bi-box-arrow-in-down me-2"></i> Registrar devolución
        </button>
      </form>
    </div>
  </div>
</div>

<script>
(() => {
  'use strict'
  const form = document.getElementById('devolucionForm');
  const estadoIngreso = form.querySelector('select[name="estado_ingreso"]');
  const observacion = form.querySelector('textarea[name="observacion"]');

  function checkObservacionRequired() {
    if (estadoIngreso.value === 'DAN') {
      observacion.setAttribute('required', 'required');
    } else {
      observacion.removeAttribute('required');
      observacion.setCustomValidity('');
    }
  }

  estadoIngreso.addEventListener('change', () => {
    checkObservacionRequired();
  });

  form.addEventListener('submit', event => {
    checkObservacionRequired();

    if (!form.checkValidity()) {
      event.preventDefault();
      event.stopPropagation();
    }
    form.classList.add('was-validated');
  });

  // Inicializa el estado correcto al cargar la página
  checkObservacionRequired();
})();
</script>
{% endblock %}
